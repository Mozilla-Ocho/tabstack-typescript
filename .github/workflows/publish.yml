name: Publish to npm

on:
  release:
    types: [created]

permissions:
  contents: read
  id-token: write

jobs:
  # Run lint checks - MUST PASS before publishing
  lint:
    name: Lint Check
    uses: ./.github/workflows/lint.yml
    permissions:
      contents: read

  # Run tests on all supported Node versions - MUST PASS before publishing
  test:
    name: Test Check
    uses: ./.github/workflows/test.yml
    permissions:
      contents: read

  # Publish only if lint and test pass
  publish:
    name: Publish Package
    needs: [lint, test]
    runs-on: ubuntu-latest
    container: node:24-slim
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup npm registry
        run: npm config set registry https://registry.npmjs.org/

      - name: Cache dependencies
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-24-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-24-

      - name: Install dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: npm ci

      - name: Build CJS module
        run: npm run build:cjs

      - name: Build ESM module
        run: npm run build:esm

      - name: Build TypeScript declarations
        run: npm run build:types

      - name: Verify build outputs
        run: |
          echo "Verifying build outputs..."
          ls -la dist/
          ls -la dist/cjs/
          ls -la dist/esm/
          ls -la dist/types/

      - name: Set version from release tag
        run: |
          # Extract version from release tag (e.g., v1.2.3 -> 1.2.3)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Setting version to $VERSION"
          npm version $VERSION --no-git-tag-version

      - name: Verify package version
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "Package version set to: $PACKAGE_VERSION"
          echo "Publishing @tabstack/sdk@$PACKAGE_VERSION"

      - name: Publish to npm
        run: npm publish --provenance --access public
